Parfait, avec les captures câ€™est clair ğŸ‘
Je te fais une correction minimale, propre et SAFE, sans casser ton design actuel, et surtout sans bloquer le job quand un serveur demande un password ou a un souci SSH.
ğŸ¯ Objectif rappelÃ©
âŒ NE PAS bloquer le job AAP
âŒ NE PAS attendre un mot de passe
âœ… Si un serveur est KO â†’ on passe au suivant
âœ… Le job doit finir en SUCCESS (ou partiel), pas en FAILED
1ï¸âƒ£ ProblÃ¨me actuel (dans checks.yml)
Ton fichier actuel :
Copy code
Yaml
- name: "Stop role if OS is not RedHat"
  ansible.builtin.meta: end_host
  when: ansible_facts['distribution'] != "RedHat"
âŒ ProblÃ¨mes
ansible_facts['distribution'] nâ€™existe pas si :
SSH KO
password demandÃ©
facts non collectÃ©s
RÃ©sultat â†’ crash immÃ©diat du job
2ï¸âƒ£ Correction RECOMMANDÃ‰E (checks.yml)
ğŸ‘‰ Remplace complÃ¨tement ton checks.yml par ceci :
Copy code
Yaml
---
# checks.yml

- name: Gather minimal facts (non blocking)
  ansible.builtin.setup:
    gather_subset:
      - min
  ignore_errors: true
  when: ansible_facts is not defined or ansible_facts == {}

- name: Skip host if facts are unavailable
  ansible.builtin.meta: end_host
  when: ansible_facts.get('distribution', '') == ''

# Stop if not RedHat
- name: Stop role if OS is not RedHat
  ansible.builtin.meta: end_host
  when: (ansible_facts.get('distribution', '') | lower) != 'redhat'

# Stop if OS version < 7
- name: Stop role if OS version is not supported
  ansible.builtin.meta: end_host
  when: (ansible_facts.get('distribution_major_version', '0') | int) < 7
âœ… Ce que Ã§a change
Aucun accÃ¨s SSH â†’ host ignorÃ©
Password demandÃ© â†’ host ignorÃ©
OS non RedHat â†’ host ignorÃ©
OS trop vieux â†’ host ignorÃ©
ğŸ”¥ Le job continue toujours
3ï¸âƒ£ SÃ©curisation cÃ´tÃ© playbook (TRÃˆS IMPORTANT)
Dans satellite_register_existing_host.yml, tu es presque bon, mais je te conseille dâ€™ajouter gather_facts: false explicitement + une precheck SSH.
ğŸ”§ Header corrigÃ©
Copy code
Yaml
- hosts: all
  strategy: free
  gather_facts: false
  any_errors_fatal: false
  ignore_unreachable: true

  pre_tasks:
    - name: Fast SSH check (no password wait)
      ansible.builtin.wait_for_connection:
        timeout: 8
      register: ssh_check
      ignore_errors: true

    - name: Skip host if SSH is not reachable
      ansible.builtin.meta: end_host
      when: ssh_check is failed
âœ… RÃ©sultat
SSH OK â†’ continue
SSH KO / password demandÃ© â†’ skip immÃ©diat
Aucun timeout long
Aucun blocage
4ï¸âƒ£ RÃ©sultat final (comportement AAP 2.6)
Situation serveur
RÃ©sultat
Password demandÃ©
â­ï¸ Skip
SSH KO
â­ï¸ Skip
Non RedHat
â­ï¸ Skip
RHEL < 7
â­ï¸ Skip
Serveur OK
âœ… Traitement
Job global
âœ… SUCCESS
5ï¸âƒ£ Bonnes pratiques AAP (check rapide)
Dans le Job Template :
âŒ Prompt on launch password â†’ dÃ©sactivÃ©
âœ… Credential SSH avec clÃ©
âŒ Pas de --ask-pass
âŒ Pas de --ask-become-pass
Si tu veux, au prochain message je peux :
te fournir un diff Git prÃªt Ã  commit
ou te faire une version ultra-clean avec tags (--skip-tags unreachable)
ou une gestion centralisÃ©e des hosts KO (reporting)
